# Pi-Trezor Raspberry Pi 5 Configuration (64-bit)
# Air-gapped wallet appliance with Trezor Core and trezord-go
# Target: ARM64 (aarch64)

# Base Raspberry Pi 5 64-bit configuration
BR2_aarch64=y
BR2_cortex_a76=y

# System
BR2_SYSTEM_DHCP=""
BR2_TARGET_GENERIC_HOSTNAME="pi-trezor"
BR2_TARGET_GENERIC_ISSUE="Pi-Trezor Air-Gapped Wallet"
BR2_TARGET_GENERIC_PASSWD_SHA256=y
BR2_SYSTEM_BIN_SH_BASH=y

# Toolchain
BR2_PACKAGE_HOST_LINUX_HEADERS_CUSTOM_6_6=y
BR2_TOOLCHAIN_BUILDROOT_GLIBC=y
BR2_TOOLCHAIN_BUILDROOT_CXX=y

# Kernel
BR2_LINUX_KERNEL=y
BR2_LINUX_KERNEL_CUSTOM_TARBALL=y
BR2_LINUX_KERNEL_CUSTOM_TARBALL_LOCATION="$(call github,raspberrypi,linux,rpi-6.6.y)/linux-rpi-6.6.y.tar.gz"
BR2_LINUX_KERNEL_USE_DEFCONFIG=y
BR2_LINUX_KERNEL_DEFCONFIG="bcm2712"
BR2_LINUX_KERNEL_CONFIG_FRAGMENT_FILES="$(BR2_EXTERNAL_PI_TREZOR_PATH)/configs/kernel_touchscreen.fragment"
BR2_LINUX_KERNEL_DTS_SUPPORT=y
BR2_LINUX_KERNEL_INTREE_DTS_NAME="bcm2712-rpi-5-b bcm2712-rpi-cm5"

# Filesystem
BR2_TARGET_ROOTFS_EXT2=y
BR2_TARGET_ROOTFS_EXT2_4=y
BR2_TARGET_ROOTFS_EXT2_SIZE="512M"
BR2_TARGET_ROOTFS_READ_ONLY=y

# Bootloader
BR2_TARGET_RPI_FIRMWARE=y
BR2_PACKAGE_RPI_FIRMWARE=y
BR2_PACKAGE_RPI_USERLAND=y

# Init system
BR2_INIT_SYSTEMD=y
BR2_PACKAGE_SYSTEMD_NETWORKD=n
BR2_PACKAGE_SYSTEMD_RESOLVED=n

# USB support for Trezor communication
BR2_PACKAGE_LIBUSB=y
BR2_PACKAGE_LIBUDEV=y
BR2_PACKAGE_LIBHIDAPI=y

# Touchscreen support
BR2_PACKAGE_TSLIB=y
BR2_PACKAGE_INPUTATTACH=y

# Disable all networking to ensure air-gapped operation
# BR2_PACKAGE_DHCPCD is not set
# BR2_PACKAGE_IFUPDOWN_SCRIPTS is not set
# BR2_PACKAGE_WIRELESS_TOOLS is not set
# BR2_PACKAGE_WPA_SUPPLICANT is not set
# BR2_PACKAGE_OPENSSH is not set
# BR2_PACKAGE_DROPBEAR is not set
# BR2_PACKAGE_IPTABLES is not set
# BR2_LINUX_KERNEL_EXT_RTLWIFI is not set

# Disable unnecessary services
# BR2_PACKAGE_AVAHI is not set
# BR2_PACKAGE_CONNMAN is not set

# Security hardening
BR2_PACKAGE_BUSYBOX_CONFIG_FRAGMENT_FILES="$(BR2_EXTERNAL_PI_TREZOR_PATH)/configs/busybox.fragment"

# Host tools
BR2_PACKAGE_HOST_DOSFSTOOLS=y
BR2_PACKAGE_HOST_GENIMAGE=y
BR2_PACKAGE_HOST_MTOOLS=y

# Target packages for Pi-Trezor operation
BR2_PACKAGE_PYTHON3=y
BR2_PACKAGE_PYTHON3_PY_PYC=y

# Pi-Trezor specific packages
BR2_PACKAGE_TREZORD_GO=y
BR2_PACKAGE_TREZOR_FIRMWARE=y

# Go support for trezord-go
BR2_PACKAGE_HOST_GO=y

# Image generation
BR2_ROOTFS_POST_BUILD_SCRIPT="$(BR2_EXTERNAL_PI_TREZOR_PATH)/board/post_build.sh"
BR2_ROOTFS_POST_IMAGE_SCRIPT="$(BR2_EXTERNAL_PI_TREZOR_PATH)/board/post_image.sh"
BR2_ROOTFS_POST_SCRIPT_ARGS="$(BR2_EXTERNAL_PI_TREZOR_PATH)"

# Overlay for Pi-Trezor binaries and configuration
BR2_ROOTFS_OVERLAY="$(BR2_EXTERNAL_PI_TREZOR_PATH)/overlay"

# Genimage configuration
BR2_PACKAGE_HOST_GENIMAGE=y